{% extends "base.html" %}

{% block title %}App Configuration{% endblock %}

{% block content %}

<h1>App Configuration</h1>
<h2>Create New Config</h2>
<form method="post" action="/config/new">
    <div class="d-flex align-items-end mb-3">
        <div class="mb-0 me-2">
            <label for="key" class="form-label">Key:</label>
            <input type="text" name="key" id="key" class="form-control" required>
        </div>
        <div class="mb-0 me-2">
            <label for="value" class="form-label">Value:</label>
            <input type="text" name="value" id="value" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Config</button>
    </div>
</form>
<hr>

<form method="post" action="/config">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for item in config %}
        <tr>
            <td>
                {{ item.key }}
            </td>
            <td>
                {% if item.key == 'RECITER' %}
                    <select name="{{ item.key }}" class="form-control">
                        {% for reciter in reciters %}
                            <option value="{{ reciter.key }}" {% if reciter.key == item.value %}selected{% endif %}>
                                {{ reciter.english_name }}
                            </option>
                        {% endfor %}
                    </select>
                {% elif item.key == 'FONT_COLOR' %}
                    <div class="d-flex align-items-center">
                        <input type="color" id="font_color_picker" class="form-control form-control-color me-2" value="#C9B59C">
                        <input type="text" name="{{ item.key }}" id="font_color_value" value="{{ item.value }}" class="form-control">
                    </div>
                {% elif item.key == 'BACKGROUND_RGB' %}
                    <div class="d-flex align-items-center">
                        <input type="color" id="bg_color_picker" class="form-control form-control-color me-2" value="#EFE9E3">
                        <input type="text" name="{{ item.key }}" id="bg_color_value" value="{{ item.value }}" class="form-control">
                    </div>
                {% elif item.key == 'UPLOAD_TO_YOUTUBE' %}
                    <div class="form-check form-switch">
                        <input type="checkbox" id="upload_to_youtube_checkbox" class="form-check-input" role="switch" {% if item.value == 'True' %}checked{% endif %}>
                        <input type="hidden" name="{{ item.key }}" id="upload_to_youtube_value" value="{{ item.value }}">
                    </div>
                {% elif item.key == 'ENABLE_FACEBOOK_UPLOAD' %}
                    <div class="form-check form-switch">
                        <input type="checkbox" id="enable_facebook_upload_checkbox" class="form-check-input" role="switch" {% if item.value == 'True' %}checked{% endif %}>
                        <input type="hidden" name="{{ item.key }}" id="enable_facebook_upload_value" value="{{ item.value }}">
                    </div>
                {% elif item.key == 'WBW_FULL_TRANSLATION_ENABLED' or item.key == 'WBW_INTERLINEAR_ENABLED' %}
                    <div class="form-check form-switch">
                        <input type="checkbox" id="{{ item.key }}_checkbox" class="form-check-input dynamic-switch" role="switch" data-target="{{ item.key }}_value" {% if item.value == 'True' %}checked{% endif %}>
                        <input type="hidden" name="{{ item.key }}" id="{{ item.key }}_value" value="{{ item.value }}">
                    </div>
                {% elif item.key == 'DEFAULT_LANGUAGE' %}
                    <select name="{{ item.key }}" id="default_language_select" class="form-control">
                        {% for language in languages %}
                            <option value="{{ language.name }}" {% if language.name == item.value %}selected{% endif %}>
                                {{ language.name|title }}
                            </option>
                        {% endfor %}
                    </select>
                {% elif item.key == 'WBW_FULL_TRANSLATION_SOURCE' %}
                    <select name="{{ item.key }}" id="wbw_full_translation_source_select" class="form-control">
                        {# Options will be populated by JavaScript #}
                    </select>
                {% else %}
                    <input type="text" name="{{ item.key }}" value="{{ item.value }}" class="form-control">
                {% endif %}
            </td>
            <td>
                <form method="post" action="{{ url_for('config_delete', key=item.key) }}" onsubmit="return confirm('Are you sure you want to delete this item?');">
                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-success">Save All Changes</button>
</form>

<hr>
<h2>Language Settings</h2>
<form method="post" action="/config/language/update">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Language</th>
                <th>Code</th>
                <th>Font</th>
            </tr>
        </thead>
        <tbody>
        {% for lang in languages %}
            <tr>
                <td>{{ lang.name|title }}</td>
                <td>{{ lang.code }}</td>
                <td>
                    <select name="font_{{ lang.id }}" class="form-control">
                        <option value="Arial" {% if lang.font == 'Arial' %}selected{% endif %}>Arial</option>
                        <option value="Segoe UI" {% if lang.font == 'Segoe UI' %}selected{% endif %}>Segoe UI</option>
                        <option value="Times New Roman" {% if lang.font == 'Times New Roman' %}selected{% endif %}>Times New Roman</option>
                        <option value="Kalpurush" {% if lang.font == 'Kalpurush' %}selected{% endif %}>Kalpurush</option>
                        <option value="me_quran.ttf" {% if lang.font == 'me_quran.ttf' %}selected{% endif %}>Me Quran</option>
                        <option value="noorehuda.ttf" {% if lang.font == 'noorehuda.ttf' %}selected{% endif %}>Noorehuda</option>
                        <option value="{{ lang.font }}" {% if lang.font not in ['Arial', 'Segoe UI', 'Times New Roman', 'Kalpurush', 'me_quran.ttf', 'noorehuda.ttf'] %}selected{% endif %}>{{ lang.font }} (Custom)</option>
                    </select>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-primary">Save Language Settings</button>
</form>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Data from Server ---
    const langTranslations = JSON.parse('{{ lang_translations_json|safe }}');
    const currentFullTranslationSource = '{{ config|selectattr("key", "equalto", "WBW_FULL_TRANSLATION_SOURCE")|map(attribute="value")|first }}';

    // --- Elements ---
    const langSelect = document.getElementById('default_language_select');
    const translationSourceSelect = document.getElementById('wbw_full_translation_source_select');
    
    // --- Update Function ---
    function updateTranslationSources() {
        const selectedLang = langSelect.value;
        const translations = langTranslations[selectedLang] || [];
        
        // Clear existing options
        translationSourceSelect.innerHTML = '';
        
        // Populate new options
        translations.forEach(trans => {
            const option = document.createElement('option');
            option.value = trans.db_name;
            option.textContent = trans.display_name;
            if (trans.db_name === currentFullTranslationSource) {
                option.selected = true;
            }
            translationSourceSelect.appendChild(option);
        });
    }

    // --- Event Listener ---
    if (langSelect && translationSourceSelect) {
        langSelect.addEventListener('change', updateTranslationSources);
        // Initial population
        updateTranslationSources();
    }

    // ... (rest of the script)
    const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    };

    const componentToHex = (c) => {
        const hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    };

    const rgbToHex = (r, g, b) => {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    };

    const parseRgbString = (rgbStr) => {
        const match = rgbStr.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (match) {
            return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
        }
        return null;
    };

    const parseTupleString = (tupleStr) => {
        const match = tupleStr.match(/\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (match) {
            return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
        }
        return null;
    };


    // --- FONT_COLOR Picker ---
    const fontColorPicker = document.getElementById('font_color_picker');
    const fontColorValue = document.getElementById('font_color_value');

    if (fontColorPicker && fontColorValue) {
        // Initialize picker from text value
        const initialFontRgb = parseRgbString(fontColorValue.value);
        if (initialFontRgb) {
            fontColorPicker.value = rgbToHex(initialFontRgb.r, initialFontRgb.g, initialFontRgb.b);
        }

        // Update text value from picker
        fontColorPicker.addEventListener('change', function() {
            const rgb = hexToRgb(this.value);
            if (rgb) {
                fontColorValue.value = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }
        });
    }


    // --- BACKGROUND_RGB Picker ---
    const bgColorPicker = document.getElementById('bg_color_picker');
    const bgColorValue = document.getElementById('bg_color_value');

    if (bgColorPicker && bgColorValue) {
        // Initialize picker from text value
        const initialBgRgb = parseTupleString(bgColorValue.value);
        if (initialBgRgb) {
            bgColorPicker.value = rgbToHex(initialBgRgb.r, initialBgRgb.g, initialBgRgb.b);
        }

        // Update text value from picker
        bgColorPicker.addEventListener('change', function() {
            const rgb = hexToRgb(this.value);
            if (rgb) {
                bgColorValue.value = `(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }
        });
    }

    // --- UPLOAD_TO_YOUTUBE Checkbox ---
    const uploadCheckbox = document.getElementById('upload_to_youtube_checkbox');
    const uploadValue = document.getElementById('upload_to_youtube_value');

    if (uploadCheckbox && uploadValue) {
        uploadCheckbox.addEventListener('change', function() {
            uploadValue.value = this.checked ? "True" : "False";
        });
    }

    // --- ENABLE_FACEBOOK_UPLOAD Checkbox ---
    const fbUploadCheckbox = document.getElementById('enable_facebook_upload_checkbox');
    const fbUploadValue = document.getElementById('enable_facebook_upload_value');
    if (fbUploadCheckbox) {
        fbUploadCheckbox.addEventListener('change', function() {
            fbUploadValue.value = this.checked ? 'True' : 'False';
        });
    }

    // --- Dynamic Switches (WBW Settings) ---
    document.querySelectorAll('.dynamic-switch').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const targetId = this.getAttribute('data-target');
            const targetInput = document.getElementById(targetId);
            if (targetInput) {
                targetInput.value = this.checked ? "True" : "False";
            }
        });
    });
});
</script>
{% endblock %}