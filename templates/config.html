{% extends "base.html" %}

{% block title %}App Configuration{% endblock %}

{% block content %}

<h1>App Configuration</h1>
<h2>Create New Config</h2>
<form method="post" action="/config/new">
    <div class="d-flex align-items-end mb-3">
        <div class="mb-0 me-2">
            <label for="key" class="form-label">Key:</label>
            <input type="text" name="key" id="key" class="form-control" required>
        </div>
        <div class="mb-0 me-2">
            <label for="value" class="form-label">Value:</label>
            <input type="text" name="value" id="value" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Add Config</button>
    </div>
</form>
<hr>

<form method="post" action="/config">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for item in config %}
        <tr>
            <td>
                {{ item.key }}
            </td>
            <td>
                {% if item.key == 'RECITER' %}
                    <select name="{{ item.key }}" class="form-control">
                        {% for reciter in reciters %}
                            <option value="{{ reciter.key }}" {% if reciter.key == item.value %}selected{% endif %}>
                                {{ reciter.english_name }}
                            </option>
                        {% endfor %}
                    </select>
                {% elif item.key == 'FONT_COLOR' %}
                    <div class="d-flex align-items-center">
                        <input type="color" id="font_color_picker" class="form-control form-control-color me-2" value="#C9B59C">
                        <input type="text" name="{{ item.key }}" id="font_color_value" value="{{ item.value }}" class="form-control">
                    </div>
                {% elif item.key == 'BACKGROUND_RGB' %}
                    <div class="d-flex align-items-center">
                        <input type="color" id="bg_color_picker" class="form-control form-control-color me-2" value="#EFE9E3">
                        <input type="text" name="{{ item.key }}" id="bg_color_value" value="{{ item.value }}" class="form-control">
                    </div>
                {% else %}
                    <input type="text" name="{{ item.key }}" value="{{ item.value }}" class="form-control">
                {% endif %}
            </td>
            <td>
                <form method="post" action="{{ url_for('config_delete', key=item.key) }}" onsubmit="return confirm('Are you sure you want to delete this item?');">
                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    <button type="submit" class="btn btn-success">Save All Changes</button>
</form>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Helper Functions ---
    const hexToRgb = (hex) => {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    };

    const componentToHex = (c) => {
        const hex = c.toString(16);
        return hex.length == 1 ? "0" + hex : hex;
    };

    const rgbToHex = (r, g, b) => {
        return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    };

    const parseRgbString = (rgbStr) => {
        const match = rgbStr.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (match) {
            return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
        }
        return null;
    };

    const parseTupleString = (tupleStr) => {
        const match = tupleStr.match(/\((\d+),\s*(\d+),\s*(\d+)\)/);
        if (match) {
            return { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
        }
        return null;
    };


    // --- FONT_COLOR Picker ---
    const fontColorPicker = document.getElementById('font_color_picker');
    const fontColorValue = document.getElementById('font_color_value');

    if (fontColorPicker && fontColorValue) {
        // Initialize picker from text value
        const initialFontRgb = parseRgbString(fontColorValue.value);
        if (initialFontRgb) {
            fontColorPicker.value = rgbToHex(initialFontRgb.r, initialFontRgb.g, initialFontRgb.b);
        }

        // Update text value from picker
        fontColorPicker.addEventListener('change', function() {
            const rgb = hexToRgb(this.value);
            if (rgb) {
                fontColorValue.value = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }
        });
    }


    // --- BACKGROUND_RGB Picker ---
    const bgColorPicker = document.getElementById('bg_color_picker');
    const bgColorValue = document.getElementById('bg_color_value');

    if (bgColorPicker && bgColorValue) {
        // Initialize picker from text value
        const initialBgRgb = parseTupleString(bgColorValue.value);
        if (initialBgRgb) {
            bgColorPicker.value = rgbToHex(initialBgRgb.r, initialBgRgb.g, initialBgRgb.b);
        }

        // Update text value from picker
        bgColorPicker.addEventListener('change', function() {
            const rgb = hexToRgb(this.value);
            if (rgb) {
                bgColorValue.value = `(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }
        });
    }
});
</script>
{% endblock %}
